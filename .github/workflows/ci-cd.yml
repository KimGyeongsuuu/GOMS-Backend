name: CI/CD

on:  
  push:    
    branches: ["main"]  
  pull_request:    
    branches: ["main"]

permissions:  
  contents: read

jobs:  
  build-and-deploy:    
    runs-on: ubuntu-latest    
    steps:      
      - name: Checkout repository        
        uses: actions/checkout@v4      

      - name: Set up Go        
        uses: actions/setup-go@v4        
        with:          
          go-version: '1.21'          
          cache: true      

      - name: Login to Docker Hub        
        uses: docker/login-action@v3        
        with:          
          username: ${{ secrets.DOCKERHUB_USERNAME }}          
          password: ${{ secrets.DOCKERHUB_TOKEN }}      

      - name: Set up Docker Buildx        
        uses: docker/setup-buildx-action@v3      

      - name: Build Docker image        
        run: docker build --platform linux/amd64 -t ${{ secrets.DOCKERHUB_USERNAME }}/goms-go:latest -f ./Dockerfile .      

      - name: Push Docker image to Docker Hub        
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/goms-go:latest      

      - name: Deploy to EC2        
        if: github.ref == 'refs/heads/main'      
        uses: appleboy/ssh-action@v0.1.6        
        with:          
          host: ${{ secrets.EC2_HOST }}          
          username: ${{ secrets.EC2_USER }}          
          key: ${{ secrets.EC2_SSH_KEY }}          
          port: 22          
          script: |            
            cd GOMS-Backend/            
            docker-compose down            
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/goms-go:latest            
            docker-compose up -d
